trigger accountCaseTrigger on Account (After Update) {
    
    /*if(Trigger.isAfter && Trigger.isUpdate){
        set<id> accountIdsSet = new set<id>();
        for(account acnt : Trigger.new){
            Account oldacnt = Trigger.oldMap.get(acnt.id);
            if(acnt.Customerrelationship_Status__c != oldacnt.Customerrelationship_Status__c 
               && acnt.Customerrelationship_Status__c =='no relation'){
                   accountIdsSet.add(acnt.id); 
               }         
        }
        if(!accountIdsSet.isempty()){
            List<case> caselisttoupdate = new List<case>();
            for(case cs: [select Id,status,AccountId
                          from Case
                          Where accountid in:   accountIdsSet and status!='closed' ]){
                              cs.status = 'closed';
                              caselisttoupdate.add(cs);
                          }
            if(! caselisttoupdate.isempty()){
                update caselisttoupdate;
            }
        }
    }*/
   
    if (Trigger.isAfter && Trigger.isUpdate) {
        Set<Id> accountIdsToUpdateCases = new Set<Id>();

        // Collect Account IDs where Customer Relationship Status changed to 'no relation'
        for (Account updatedAccount : Trigger.new) {
            Account oldAccount = Trigger.oldMap.get(updatedAccount.Id);
            if (updatedAccount.Customerrelationship_Status__c != oldAccount.Customerrelationship_Status__c 
                && updatedAccount.Customerrelationship_Status__c == 'no relation') {
                accountIdsToUpdateCases.add(updatedAccount.Id);
            }
        }

        if (!accountIdsToUpdateCases.isEmpty()) {
            // Query Cases related to the updated Accounts
            List<Case> casesToUpdate = [SELECT Id, Status FROM Case 
                                        WHERE AccountId IN :accountIdsToUpdateCases AND Status != 'closed'];

            // Update Cases to 'closed'
            for (Case c : casesToUpdate) {
                c.Status = 'closed';
            }

            // Perform bulk update
            if (!casesToUpdate.isEmpty()) {
                update casesToUpdate;
            }

            // Close Cases related to Contacts of the updated Accounts
            List<Case> casesRelatedToContacts = [SELECT Id, Status FROM Case 
                                                 WHERE Contact.AccountId IN :accountIdsToUpdateCases AND Status != 'closed'];

            // Update Cases to 'closed'
            for (Case c : casesRelatedToContacts) {
                c.Status = 'closed';
            }

            // Perform bulk update
            if (!casesRelatedToContacts.isEmpty()) {
                update casesRelatedToContacts;
            }
        }
    } 
}